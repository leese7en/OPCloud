<link rel="stylesheet" href="/stylesheets/styles.css"/>
<script src="/plugins/sweetalert/dist/sweetalert-dev.js"></script>
<link rel="stylesheet" href="/plugins/sweetalert/dist/sweetalert.css">
<script src="/javascripts/jquery.md5.js"></script>
<style type="text/css">
    body {
        background-image: url('/images/bg.jpg');
    }
</style>
<body>
<div class="container">
    <div class="row">
        <br>
        <div class="col-lg-8 col-lg-offset-2 text-center">
            <h2 class="text-primary" style="color:#fff;">找回密码</h2>
            <hr class="primary">
        </div>
        <div class="col-lg-4 col-lg-offset-4">
            <div class="col-md-12">
                <label></label>
                <input type="text" class="form-control" placeholder="用户名" name="jobNo" id="jobNo">
            </div>
            <div class="col-md-12">
                <label></label>
                <input type="text" class="form-control" placeholder="注册时的手机号" name="phone" id="phone">
            </div>
            <div class="col-md-12">
                <label></label>
                <input type="password" class="form-control" placeholder="新密码" name="password" id="password">
            </div>
            <div class="col-md-12">
                <label></label>
                <input type="password" class="form-control" placeholder="确认密码" name="password2" id="password2">
            </div>
            <div class="col-md-12 text-left" style="margin-top: 20px">
                <div class="col-md-9">
                    <input type="text" class="form-control" placeholder="验证码" name="smsCode" id="smsCode" style="margin-left:-15px; ">
                </div>
                <div class="col-md-3">
                    <button type="button" id="sendSmsCode" onclick="getPhoneSmsCode()" class="btn btn-success"
                            style="border-radius: 0.2em;margin-top:10px;margin-left:-30px; ">
                        获取验证码
                    </button>
                </div>

            </div>
            <div class="col-md-8 col-md-offset-3" style="margin-top: 30px">
                <label></label>
                <button type="button" class="btn btn-log1 btn-lg" style="width:90px;float:left;margin-right:20px;" onclick="submitInfo()">提交</button>
                <a onclick="javascripts:self.location='/'" style="line-height:40px;font-size:18px;">返回登录
                </a>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    //忘记密码页面,发送邮件
    function submitInfo() {
        var jobNo = $('#jobNo').val().trim();
        if (!jobNo) {
            errorSwal('用户名不能为空');
            return;
        }
        var phone = $('#phone').val().trim();
        if (!jobNo) {
            errorSwal('手机号不能为空');
            return;
        }
        var smsCode = $('#smsCode').val();
        if (!smsCode) {
            errorSwal('验证码不能为空');
            return;
        }
        var password = $('#password').val();
        var password2 = $('#password2').val();
        if (!password) {
            errorSwal('密码不能为空');
            return;
        }
        if (!password2) {
            errorSwal('确认密码不能为空');
            return;
        }
        if (password != password2) {
            errorSwal('两次密码不一样 ');
            return;
        }
        password = $.md5(password);
        password2 = $.md5(password2);
        $.ajax({
            type: 'post',
            url: '/system/user/forgetPwd',
            data: {
                jobNo: jobNo,
                phone: phone,
                smsCode: smsCode,
                password: password,
                password2: password2
            },
            dataType: 'json',
            success: function (data) {
                var flag = data.flag;
                if (flag < 0) {
                    toastr.warning(data.message);
                    return;
                }
                else {
                    successSwal('修改成功，即将跳转到登录页面');
                    self.location = '/';
                }
            },
            error: function () {

            }
        });
    }
    function getPhoneSmsCode() {
        var phone = $("#phone").val();
        if (phone == null || phone == "") {
            errorSwal("联系方式不能为空！");
            return;
        }
        $.ajax({
            type: 'POST',
            url: "/system/publicInfo/sendCloudSmsCode",
            data: {
                phone: phone
            },
            dataType: "json",
            success: function (data) {
                if (data.flag < 0) {
                    toastr.warning(data.message);
                    return;
                } else {
                    swal("你的验证码!", data.data, "success");
                    var i = 60;
                    var j = setInterval(function () {
                        $('#sendSmsCode').attr('disabled', 'disabled').html('重新发送' + i);
                        i--;
                        if (i < 1) {
                            $('#sendSmsCode').removeAttr('disabled').html('获取验证码');
                            clearInterval(j);
                        }
                    }, 1000);
                }
            },
            error: function (err) {
                toastr.error(err);
            }
        });
    }
</script>
