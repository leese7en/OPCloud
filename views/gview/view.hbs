<script type="text/javascript" src="/javascripts/jquery.ba-resize.js"></script>
<link rel="stylesheet" href="/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css">
<script src="/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
<script src="/plugins/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js"
        type="text/javascript"></script>
<link href="/plugins/bootstrap-select2/css/select2.min.css" rel="stylesheet"/>
<script src="/plugins/bootstrap-select2/js/select2.js"></script>
<script src="/plugins/bootstrap-select2/js/i18n/zh-CN.js"></script>
<link href="/plugins/bootstrap-colorpicker/css/bootstrap-colorpicker.min.css" rel="stylesheet"/>
<script src="/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.min.js"></script>
<script type="text/javascript" src="/plugins/trend-canvas/trendCanvas.js"></script>
<script type="text/javascript" src="/plugins/sweetalert/sweetalert.min.js"></script>
<link rel="stylesheet" type="text/css" href="/plugins/sweetalert/sweetalert.css">
<link href="/plugins/bootstrap-switch/dist/css/bootstrap3/bootstrap-switch.css" rel="stylesheet">
<script src="/plugins/bootstrap-switch/dist/js/bootstrap-switch.js"></script>
<link href="http://cdn.gbtags.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<link href="/stylesheets/mobiscroll_date.css" rel="stylesheet"/>
<link href="/stylesheets/pointmodal.css" rel="stylesheet"/>
<script src="/plugins/mobile-date/mobiscroll_date.js"></script>
<script src="/plugins/mobile-date/mobiscroll.js"></script>
<script type="text/javascript" src="/javascripts/gview/gview.js"></script>
<script type="text/javascript" src="/plugins/view-canvas/viewCanvas.js"></script>
<style>
    @font-face {
        font-family: GViewDigital;
        src: url("/plugins/DigitalRegular.ttf")
    }

    .spinner {
        width: 100px;
    }

    .spinner input {
        text-align: right;
    }

    .input-group-btn-vertical {
        position: relative;
        white-space: nowrap;
        width: 1%;
        vertical-align: middle;
        display: table-cell;
    }

    .input-group-addon {
        padding: 6px;
    }

    .btn {
        padding: 6px;
    }

    .input-group-btn-vertical > .btn {
        display: block;
        float: none;
        width: 100%;
        max-width: 100%;
        padding: 8px;
        margin-left: -1px;
        position: relative;
        border-radius: 0;
    }

    .input-group-btn-vertical > .btn:first-child {
        border-top-right-radius: 4px;
    }

    .input-group-btn-vertical > .btn:last-child {
        margin-top: -2px;
        border-bottom-right-radius: 4px;
    }

    .input-group-btn-vertical i {
        position: absolute;
        top: 0;
        left: 4px;
    }

    .btn-mobile {
        height: 50px;
        padding: 3px 10px;
        font-size: 28px;
    }

    .mobilePointtable .form-control {
        height: 40px;
        font-size: 28px;
        padding: 1px 3px;
    }

    .mobilePointtable .input-group-addon {
        font-size: 24px;
        padding: 3px 3px;
    }

    #pointsTrendManage {
        font-size: 24px;
    }

    #pointsTrendManage .form-control {
        height: 40px;
        font-size: 24px;
        padding: 1px 3px;
    }

    #pointsTrendManage .input-group-addon {
        font-size: 24px;
        padding: 3px 3px;
    }

    .select2-dropdown {
        z-index: 10000;
    }

    .theme-popover .select2-container {
        font-size: 24px;
    }

    .theme-popover .select2-container .select2-dropdown {
        font-size: 24px;
    }

    .theme-popover .select2-container .select2-search__field {
        font-size: 24px;
    }

</style>

<div class="modal fade" id="pointsTrendManage" tabindex="-1" role="dialog" aria-hidden="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="padding:8px;">
                <h4 class="modal-title" style="font-size: 24px">
                    测点管理
                </h4>
            </div>
            <div class="modal-body" style="padding-top:1px;">
                <div class="box box-primary" style="height:26%">
                    <form class="form-horizontal" role="form">
                        <div class="row">
                            <label>开始时间</label>
                            <span id="trend_from_m"
                                  style="border:1px solid red;font-size:24px;display:inline-block;width: 30%">开始时间</span>
                            <label>结束时间</label>
                            <span id="trend_to_m"
                                  style="border:1px solid red;font-size:24px;display:inline-block;width: 30%">结束时间</span>
                            <button type="button" class="btn btn-success" style="font-size:24px;" onclick="queryData()">
                                查询
                            </button>
                        </div>
                    </form>
                    <div class="pointInfoTableDiv" style="overFlow-y: scroll; overflow-x: hidden;width: 100%;">
                        <table id="pointInfoTableManage" border="1px" cellspacing="0px" bordercolor="#C0C0C0">
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <center><img src="/images/cancel.png" style="width:96px;height:96px;"
                         onclick="closePointsTrendManageModal()"/></center>
        </div>
    </div>
</div>
<div class="modal fade in" id="pointsTrend" role="dialog" aria-hidden="true" style="z-index:100;">
    <div class="modal-dialog" style="width: 1200px;height:600px;">
        <div class="modal-content">
            <div class="modal-header" style="padding:8px 4px;">
                <h4 class="modal-title">
                    <div class="notMobile">趋势信息
                        <span style="padding-right:10px;float:right;margin-top: -5px;">
                            <button type="button" class="btn btn-info glyphicon glyphicon-minus" style="margin-left:10px;"
                                    onclick="onTrendInfoMin()">
                            </button>
                            <button type="button" class="btn btn-info glyphicon glyphicon-resize-small"
                                    style="margin-left:10px;" onclick="resizeTrendInfoMin()">
                            </button>
                            <button type="button" class="btn btn-info glyphicon glyphicon-resize-full"
                                    style="margin-left:10px;" onClick="resizeTrendInfoMax()">
                            </button>
                            <button type="button" class="btn btn-info glyphicon glyphicon-remove" style="margin-left:10px;"
                                    onClick="closeTrendInfo()">
                            </button>
                        </span>
                    </div>
                    <div class="isMobile" style="display:none;min-height: 30px;">
                        <ul class="nav navbar-left" style="color: black; font-size: 20px;width:100%;">
                        <span class="btnOperator">
                            <button type="button" class="btn btn-primary btn-mobile" style="margin-right:5px;"
                                    onclick="openPointsTrendManage()">
                                点管理
                            </button>
                            <button type="button" class="btn btn-warning btn-mobile" style="margin-right:5px;"
                                    onclick="pointManage()">
                                添加点
                            </button>
                            <div class="btn-group" role="group" aria-label="Second group">
                                <button type="button" class="btn btn-success btn-mobile" style="margin-right:5px;"
                                        onclick="shortCutSearch(0)">
                                    实时
                                </button>
                                 <button type="button" class="btn btn-success btn-mobile" style="margin-right:5px;"
                                         onclick="shortCutSearch(1)">
                                   1H
                                </button>
                                 <button type="button" class="btn btn-success btn-mobile" style="margin-right:5px;"
                                         onclick="shortCutSearch(8)">
                                   8H
                                </button>
                                 <button type="button" class="btn btn-success btn-mobile" style="margin-right:5px;"
                                         onclick="shortCutSearch(24)">
                                   1D
                                </button>
                                 <button type="button" class="btn btn-success btn-mobile" style="margin-right:5px;"
                                         onclick="shortCutSearch(168)">
                                    7D
                                </button>
                                <button type="button" class="btn btn-success btn-mobile" style="margin-right:5px;"
                                        onclick="shortCutSearch(720)">
                                    30D
                                </button>
                            </div>
                            <button type="button" class="btn btn-info btn-mobile" style="margin-right:10px;"
                                    onclick="adaptiveRange()">
                                自适应量程
                            </button>
                        </span>
                            <span style="padding-right:10px;float:right;">
                            <button type="button" class="btn btn-info glyphicon glyphicon-minus btn-mobile"
                                    style="margin-left:10px;" onclick="onTrendInfoMin()">
                            </button>
                            <button type="button" class="btn btn-info glyphicon glyphicon-remove btn-mobile"
                                    style="margin-left:10px;" onClick="closeTrendInfo()">
                            </button>
                        </span>
                        </ul>
                    </div>
                </h4>
            </div>
            <div class="modal-body" style="padding-top:1px;padding-bottom:1px;">
                <div class="box box-primary" style="height:26%">
                    <div class="row" style="padding-top: 2px; padding-left: 10px;">
                        <div class="notMobile">
                            <table style="width:100%;">
                                <tr>
                                    <td style="width:25%;">
                            <span class="input-group" style="color: black; padding: 3px;width:100%;" id="pointNameCon">
                                    <span class="input-group-addon"
                                          style="color: black;padding: 3px;">名称</span>
                                <select id="pointName" class="pointName form-control" style="width: 90%">
                                    <option value="-1" selected="selected">请输入测点</option>
                                </select>
                            </span>
                                    </td>
                                    <td style="width:20%;">
                            <span class="form-group">
                                <span class="input-group" style="color: black; padding: 3px;"> <span
                                        class="input-group-addon"
                                        style="color: black; padding: 3px;">开始时间</span>
                                        <div id="trend_from" class="input-group date form_datetime">
                                        <input class="form-control" type="text">
                                        <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                        </span>
                                </div> </span>
                            </span>
                                    </td>
                                    <td style="width:20%;">
                            <span class="input-group" style="color: black; padding: 3px;">
                                <span class="input-group-addon"
                                      style="color: black; padding: 3px;">结束时间</span>
                                        <div id="trend_to" class="input-group date form_datetime">
                                        <input class="form-control" type="text">
                                        <span class="input-group-addon" style="height: 31px"> 
                                        <span class="glyphicon glyphicon-calendar"></span>
                                        </span>
                                </div> </span>
                                        </span>
                                    </td>
                                    <td style="width:10%;">
                           <span class="form-group">
                                <span class="input-group" style="color: black; padding: 3px;">
                                    <span class="input-group-addon">时间</span>
                                    <select id="trendTime" style="width: 100%" class="form-control">
                                        <option value="-1">
                                            请选择
                                        </option>
                                        <option value="0" selected="selected">
                                            实时
                                        </option>
                                        <option value="1">
                                            1时
                                        </option>
                                        <option value="8">
                                            8时
                                        </option>
                                        <option value="24">
                                            1天
                                        </option>
                                        <option value="72">
                                            3天
                                        </option>
                                        <option value="168">
                                            7天
                                        </option>
                                        <option value="360">
                                            15天
                                        </option>
                                        <option value="720">
                                            30天
                                        </option>
                                    </select>
                                </span>
                            </span>
                                    </td>
                                    <td style="width:25%;">
                                        <a class="remove" href="javascript:void(0)" title="查询">
                                            <button type="button" class="btn btn-success btn-sm" onclick="queryData()">
                                                <i class="glyphicon glyphicon-ok"></i>
                                            </button>
                                        </a>
                                        <a class="remove" href="javascript:void(0)" title="量程自适应">
                                            <button type="button" class="btn btn-info btn-sm" onclick="adaptiveRange()">
                                                <i class="glyphicon glyphicon-signal"></i>
                                            </button>
                                        </a>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div style="overFlow-y: scroll; overflow-x: hidden;height: 80%;width: 100%;">
                        <table id="pointInfoTable" border="1px" cellspacing="0px" bordercolor="#C0C0C0"
                               style="width:100%;">
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div style="margin-top:25px;">
                    <canvas id="trend_container"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toolbar" style="display:none;margin-top: 0px;background-color: #d9d9d9;width: 100%;">
    <button id="mainBtn" class="btn btn-primary " onclick="mainPage()"> 主页</button>
    <input id="paint" type="text" value="" maxlength="5" style="max-width: 100px;display: none"/>
    <button id="previousBtn" class="btn btn-primary " onclick="previousPage()"> 上一页</button>
    <button id="nextBtn" class="btn btn-primary " onclick="nextPage()"> 下一页</button>
    <button id="nextBtn" class="btn btn-primary " onclick="indexMenuDiagram()"> 设定为主页</button>

</div>
<div id="myGview" style=""></div>
<div class="modal fade" id="CTRL_Modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 400px">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    控制面板
                </h4>
            </div>
            <div class="modal-body">
                <table>
                    <tr>
                        <td>控制点：</td>
                        <td nowrap="true">
                            <label ID="key" style="margin-top: 5px;margin-right: 10px"></label>
                        </td>
                        <td>操作：</td>
                        <td width="120px"><input type="checkbox" id="CTRL_DX" style="display: none">
                            <div class="input-group spinner" id="CTRL_TEXT">
                                <input type="text" class="form-control" value="50">
                                <div class="input-group-btn-vertical">
                                    <button class="btn btn-default" type="button"><i class="fa fa-caret-up"></i>
                                    </button>
                                    <button class="btn btn-default" type="button"><i class="fa fa-caret-down"></i>
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer" style="">
                <button id="commit" type="button" class="btn btn-primary">
                    提交
                </button>
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    关闭
                </button>
            </div>
        </div>
    </div>
</div>
<div class="theme-popover">
    <select id="pointName" class="pointName form-control" style="width:100%;font-size: 24px;">
        <option value="-1" selected="selected">请输入测点</option>
    </select>
    |
</div>
<div class="theme-popover-mask" onclick="pointCloseManage()"></div>
<script>
    var fileName = '{{fileName}}';
    (function ($) {
        $('#CTRL_TEXT .btn:first-of-type').on('click', function () {
            $('#CTRL_TEXT input').val(parseInt($('#CTRL_TEXT input').val(), 10) + 1);
        });
        $('#CTRL_TEXT .btn:last-of-type').on('click', function () {
            $('#CTRL_TEXT input').val(parseInt($('#CTRL_TEXT input').val(), 10) - 1);
        });
    })(jQuery);
    if (window.parent.socket) {
        socket = window.parent.socket;
    } else {
        var token = '{{token}}';
        socket = io.connect(socketURI, {
            'query': 'token=' + token
        });
    }
    socket.on('disconnect', function () {
        alert("网络连接中断！");
    });

    socket.on('reconnect', function () {
        console.log("重新连接到服务器");
        if (graph) {
            graph.reload();
            trendGroup.resetSocket(socket);
            console.log("恢复页面状态成功......");
        }
    });
    var trendGroup = new defaultTrendGroup();
    var op = new opTrend();
    trendGroup.isDialog = true;
    trendGroup.trendcontainer = 'trend_container';
    trendGroup.opTrend = op;
    trendGroup.pointsTable = "pointInfoTable";
    trendGroup.socket = socket;

    /**
     * 页面加载执行
     */

    if (fileName.length <= 4) {
//        fileName = "mainmenu.zxml";
        fileName = "mainmenu.zxml";
    }
    var toolbar_height = 0;
    var DPR = window.devicePixelRatio ? window.devicePixelRatio : 1;
    //    DPR = 1;
    var window_w = 0;
    var window_h = 0;

    if (!isMobile.any()) {
        $("#toolbar").show();
        toolbar_height = 35;
        $("#toolbar").css({height: toolbar_height + "px", width: "100%"});
        window_w = $(window).width();
        window_h = $(window).height() - 5;
        document.documentElement.style.overflow = 'hidden';
        trendGroup.documentWidth = window_w;
        trendGroup.documentHeight = window_h + 15;
    } else {
        window_w = $(window).width() * DPR;
        window_h = ($(window).height() - 3) * DPR;
        document.documentElement.style.overflow = 'hidden';
//
//        $("#toolbar").show();
//        toolbar_height = 35;
//        $("#toolbar").css({height: toolbar_height + "px", width: window_w});

        trendGroup.isMobile = true;
        trendGroup.documentWidth = window_w - 20;
        trendGroup.documentHeight = window_h - 80;
        trendGroup.trendInfoHeight = 30;
        trendGroup.trendCanvasPrecent = 0.8;
        if (trendGroup.documentWidth < trendGroup.documentHeight) {
            trendGroup.opTrend.widthRatioA = 12;
            trendGroup.iosPlus = false;
        } else {
            trendGroup.opTrend.widthRatioA = 13;
            if (trendGroup.documentWidth > 1500) {
                trendGroup.documentHeight = trendGroup.documentHeight - 160;
                trendGroup.iosPlus = true;
            }
        }
        document.addEventListener("visibilitychange", function () {
            if (trendGroup && trendGroup.defaultTrendString && trendGroup.defaultTrendString.length > 0) {
                trendGroup.pageVisibility();
            }
        }, false);
    }
    $(window).resize(function () {
        //浏览器窗口变化
        if (trendGroup) {
            if (trendGroup.isMobile) {
                window_w = $(window).width() * DPR;
                window_h = $(window).height() * DPR - 10;
                trendGroup.documentWidth = window_w - 20;
                trendGroup.documentHeight = window_h - 80;
                if (trendGroup.documentWidth < trendGroup.documentHeight) {
                    trendGroup.opTrend.widthRatioA = 12;
                } else {
                    trendGroup.opTrend.widthRatioA = 13;
                    if (trendGroup.documentWidth > 1500) {
                        trendGroup.documentHeight = trendGroup.documentHeight - 160;
                        trendGroup.iosPlus = true;
                    }
                }
                if (trendGroup.defaultTrendString && trendGroup.defaultTrendString.length > 0) {
                    trendGroup.showDialog();
                }
                trend_Util.setCanvasClick(trendGroup);
                trend_Util.setCanvasFun(trendGroup);
            } else {
                trendGroup.documentWidth = $(window).width();
                trendGroup.documentHeight = $(window).height();
                if (trendGroup.defaultTrendString && trendGroup.defaultTrendString.length > 0) {
                    trendGroup.showDialog();
                }
            }
        }
    });

    var gviewdiv = $("#myGview");
    var w = window_w;
    var h = window_h - toolbar_height;
    gviewdiv.width(w);
    gviewdiv.height(h);
    initPointName();
    initDate();
    var graph = new openPlant.Graph({
        "target": "myGview",
        'imageSrcPrefix': '/diagram/imglib/',
        'name': fileName,
        "socket": socket
    });
    graph.setElementMouseClickListener(function (_select_object) {
        var _length = _select_object.length;
        for (var _i = _length - 1; _i >= 0; _i--) {
            var _selected_element = _select_object[_i];
            var _class = _selected_element['class'];
            switch (_class) {
                case openPlant.GraphConst.TYPE_DASPOINT: {
                    var _pn = _selected_element[openPlant.GraphConst.PROPERTY_ONTREND];
                    var _pnc = _selected_element[openPlant.GraphConst.PROPERTY_POINT];

                    if (_pnc) {
                        if (_pn) {
                            _pn += ',' + _pnc;
                        } else {
                            _pn = _pnc;
                        }
                    }
                    if (_pn) {
                        trendGroup.addName(_pn.toString());
                    }
                    break;
                }
                case openPlant.GraphConst.TYPE_TEXT: {
                    var _pn = _selected_element[openPlant.GraphConst.PROPERTY_ONTREND];
                    var _pnc = _selected_element[openPlant.GraphConst.PROPERTY_POINT];
                    if (_pnc) {
                        if (_pn) {
                            _pn += ',' + _pnc;
                        } else {
                            _pn = _pnc;
                        }
                    }
                    if (_pn) {
                        trendGroup.addName(_pn.toString());
                    }
                    break;
                }
                default:
                    break;
            }
        }
    });
</script>